(()=>{var lt=Object.defineProperty;var ke=Object.getOwnPropertySymbols;var dt=Object.prototype.hasOwnProperty,ut=Object.prototype.propertyIsEnumerable;var ce=(t,e,n)=>e in t?lt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,y=(t,e)=>{for(var n in e||(e={}))dt.call(e,n)&&ce(t,n,e[n]);if(ke)for(var n of ke(e))ut.call(e,n)&&ce(t,n,e[n]);return t};var p=(t,e,n)=>ce(t,typeof e!="symbol"?e+"":e,n);var g=(t,e,n)=>new Promise((i,o)=>{var s=l=>{try{u(n.next(l))}catch(c){o(c)}},a=l=>{try{u(n.throw(l))}catch(c){o(c)}},u=l=>l.done?i(l.value):Promise.resolve(l.value).then(s,a);u((n=n.apply(t,e)).next())});function k(){return`10000000-1000-4000-8000-${1e11}`.replace(/[018]/g,t=>{let e=crypto.getRandomValues(new Uint8Array(1))[0];return(+t^e&15>>+t/4).toString(16)})}var V=t=>{let e=/^[a-fA-F0-9]+$/,n=t.length;return!!({32:"MD5",40:"SHA-1",64:"SHA-256",128:"SHA-512"}[n]&&e.test(t))};function R(t,e=!0){return g(this,null,function*(){if(!t)return"";e&&(t=t.toLowerCase());let n=new TextEncoder().encode(t),i=yield window.crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(i)).map(a=>a.toString(16).padStart(2,"0")).join("")})}var D=()=>/Safari/i.test(window.navigator.userAgent)&&!/Chrome/i.test(window.navigator.userAgent);function G(t,e){let n=e.split("&");for(let i=0;i<n.length;i++){let o=n[i].split("=");if(o[0]===t)return o[1]}return null}function Re(){let t=localStorage.getItem("gpuInfo");if(t)try{return JSON.parse(t)}catch(u){}let e=document.createElement("canvas"),n=null;for(let u of["webgl2","webgl","experimental-webgl"])try{let l=e.getContext(u);if(l&&(l instanceof WebGLRenderingContext||l instanceof WebGL2RenderingContext)){n=l;break}}catch(l){}if(!n)return null;let i="N/A",o="N/A",s=n.getExtension("WEBGL_debug_renderer_info");try{s?(i=n.getParameter(s.UNMASKED_VENDOR_WEBGL)||"N/A",o=n.getParameter(s.UNMASKED_RENDERER_WEBGL)||"N/A"):(i=n.getParameter(n.VENDOR)||"N/A",o=n.getParameter(n.RENDERER)||"N/A")}catch(u){}let a={vendor:i,renderer:o};return localStorage.setItem("gpuInfo",JSON.stringify(a)),a}function S(t){if(!t||t.length>254)return!1;let e=t.split("@");if(e.length!==2)return!1;let[n,i]=e;return n.length>64||n.length===0||i.length>253||i.length===0?!1:/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(t)}function _(t){if(!t)return!1;let e=t.replace(/[\s\-+().]/g,"");return/^\d+$/.test(e)?e.length>=7&&e.length<=15:!1}function j(t){let e=new URLSearchParams;return Object.entries(t).forEach(([n,i])=>{i&&(typeof i=="object"?e.append(n,JSON.stringify(i)):e.append(n,String(i)))}),e.toString()}function q(t,e,n="",i,o=!1){if(!e)return;let s=[];s.push(`${t}=${e}`),n&&s.push(`expires=${n}`),s.push("path=/"),i&&s.push(`domain=${i}`),s.push("SameSite=Lax"),o&&s.push("Secure"),document.cookie=s.join(";")}function A(t){try{let e=document.cookie.split("; ").find(i=>i.startsWith(`${t}=`));return e?e.split("=")[1]:""}catch(e){return""}}function F(t,e,n){if(!e)return;let i=new Date;i.setMonth(i.getMonth()+1);let s=n.replace("www.","").split(".");if(s.length===1){q(t,e,i.toUTCString(),void 0,!0);return}let a=`.${s.slice(-2).join(".")}`;q(t,e,i.toUTCString(),a,!0),!A(t)&&s.length>2&&(a=`.${s.slice(-3).join(".")}`,q(t,e,i.toUTCString(),a,!0)),D()&&localStorage&&localStorage.setItem(t,e)}var h=class h{constructor(){p(this,"config");let e=h.DEBUG_FLAG_KEY,n=null;try{let l=localStorage.getItem(h.STORAGE_LEVEL_KEY);if(l){let c=JSON.parse(l);Date.now()-c.ts<3e5?n=c.level:localStorage.removeItem(h.STORAGE_LEVEL_KEY)}}catch(l){}let i=(()=>{try{return localStorage.getItem(e)==="1"}catch(l){return!1}})(),o=(()=>{try{return new URLSearchParams(window.location.search).get(e)==="1"}catch(l){return!1}})(),s=(()=>{try{let l=localStorage.getItem(h.STORAGE_OPTS_KEY);return l?JSON.parse(l):null}catch(l){return null}})(),a=i||n&&n!=="off"||o,u=n&&n!=="off"?n:i||o?"debug":"error";this.config={enabled:a,level:a?u:"error",prefix:"[Nextdoor Pixel]",includeTimestamp:!!(s!=null&&s.includeTimestamp),includeLocation:!!(s!=null&&s.includeLocation)}}formatPrefix(e){let n=[this.config.prefix,`[${e.toUpperCase()}]`];if(this.config.includeTimestamp)try{n.push(new Date().toISOString())}catch(i){}if(this.config.includeLocation){let i=this.getCallerLocation();i&&n.push(`(${i})`)}return n.join(" ")}getCallerLocation(){try{let e=new Error;if(!e.stack)return null;let n=e.stack.split(`
`).map(i=>i.trim());for(let i=1;i<n.length;i++){let o=n[i];if(!o||o.includes("basic/logger"))continue;let s=o.match(/\(?([^()]+):(\d+):(\d+)\)?$/);if(s){let a=s[1],u=s[2];return`${a}:${u}`}}return null}catch(e){return null}}shouldLog(e){if(!this.config.enabled)return!1;let n=["debug","info","warn","error"],i=n.indexOf(this.config.level);return n.indexOf(e)>=i}debug(e,...n){this.shouldLog("debug")&&(console.groupCollapsed(`${this.formatPrefix("debug")} ${e}`,...n),console.trace(),console.groupEnd())}info(e,...n){this.shouldLog("info")&&console.log(`${this.formatPrefix("info")} ${e}`,...n)}warn(e,...n){this.shouldLog("warn")&&console.warn(`${this.formatPrefix("warn")} ${e}`,...n)}error(e,...n){this.shouldLog("error")&&console.error(`${this.formatPrefix("error")} ${e}`,...n)}enableDebug(){this.config.enabled=!0,this.config.level="debug";try{localStorage.setItem("ndp_debug","1");let e={level:"debug",ts:Date.now()};localStorage.setItem(h.STORAGE_LEVEL_KEY,JSON.stringify(e))}catch(e){}console.log(`${this.config.prefix} Debug mode enabled`)}disable(){this.config.enabled=!1;try{localStorage.removeItem("ndp_debug");let e={level:"off",ts:Date.now()};localStorage.setItem(h.STORAGE_LEVEL_KEY,JSON.stringify(e))}catch(e){}}setLevel(e){if(e==="off")this.disable();else{this.config.enabled=!0,this.config.level=e;try{let n={level:e,ts:Date.now()};localStorage.setItem(h.STORAGE_LEVEL_KEY,JSON.stringify(n))}catch(n){}console.log(`${this.config.prefix} Log level set to '${e}'`)}}setOptions(e){try{typeof e.includeTimestamp=="boolean"&&(this.config.includeTimestamp=e.includeTimestamp),typeof e.includeLocation=="boolean"&&(this.config.includeLocation=e.includeLocation);let n={includeTimestamp:this.config.includeTimestamp,includeLocation:this.config.includeLocation};localStorage.setItem(h.STORAGE_OPTS_KEY,JSON.stringify(n)),console.log(`${this.config.prefix} Log options updated`,n)}catch(n){}}};p(h,"STORAGE_LEVEL_KEY","ndp_log_level"),p(h,"DEBUG_FLAG_KEY","ndp_debug"),p(h,"STORAGE_OPTS_KEY","ndp_log_opts");var $=h,r=new $;typeof window!="undefined"&&(window.ndpDebug=()=>(r.enableDebug(),"Nextdoor Pixel debug mode enabled. Check console for detailed logs."),window.ndpLog=t=>(r.setLevel(t),`Nextdoor Pixel log level set to '${t}'.`),window.ndpLogOptions=t=>(r.setOptions(t),"Nextdoor Pixel log options updated."),window.ndpReset=t=>{try{let e=[],n=()=>{try{localStorage.removeItem($.DEBUG_FLAG_KEY)}catch(o){}try{localStorage.removeItem($.STORAGE_LEVEL_KEY)}catch(o){}r.disable(),e.push("debug flags")},i=()=>{try{sessionStorage.removeItem("ndp_settings")}catch(o){}try{sessionStorage.removeItem("ndp_settings_expiry")}catch(o){}e.push("settings cache")};if(t)t==="debug"?n():t==="setting"&&i();else{n();try{localStorage.removeItem("gpuInfo")}catch(o){}try{localStorage.removeItem("ndp_session_id")}catch(o){}try{localStorage.removeItem("ndclid")}catch(o){}i(),e.push("gpuInfo","ndp_session_id","ndclid")}return`Nextdoor Pixel reset completed: ${e.join(", ")||t||"none"}`}catch(e){return"Nextdoor Pixel reset encountered an error (see console)."}});var le="user_email_hash",de="user_email",E="ndclid",N="ndp_session_id",De=["order_value","product_context","order_id"],B=["email","phone_number","first_name","last_name","gender","street_address","city","state","zip_code","country"];var Fe="Manual",b="https://flask.nextdoor.com/pixel";var ue=class{constructor(){p(this,"pseudoMappings",{":nth-of-type(":":t(",":nth-last-child(":":l(",":nth-last-of-type(":":lt(",":nth-child(":":n("});p(this,"reverseMappings",this.buildReverseMappings());p(this,"regexCache",new Map)}buildReverseMappings(){let e={};for(let[n,i]of Object.entries(this.pseudoMappings))e[i]=n;return e["|"]=" ",e}getOrCreateRegex(e){this.regexCache.has(e)||this.regexCache.set(e,new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"));let n=this.regexCache.get(e);if(!n)throw new Error("Failed to create regex pattern");return n}toDSL(e){if(!e||e.trim()==="")return e;let n=e.trim();for(let[i,o]of Object.entries(this.pseudoMappings)){let s=this.getOrCreateRegex(i);n=n.replace(s,o)}return n=n.replace(/\s+/g,"|"),n=n.replace(/\s+/g,""),n}fromDSL(e){if(!e||e.trim()==="")return e;let n=e.trim(),i=Object.entries(this.pseudoMappings).map(([o,s])=>[s,o]).sort(([o],[s])=>s.length-o.length);for(let[o,s]of i)n=n.replace(new RegExp(o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),s);return n=n.replace(/\|/g," "),n}isValidDSL(e){return!e||e.trim()===""?!1:!/[$%^&*()_+={}[\]|\\:;"'<>?,./]/.test(e)}},gt=new ue;var K=t=>gt.fromDSL(t);var ge=0;function $e(t=2e3){ge=Date.now()+Math.max(0,t);try{r.debug("[transport] enter critical beacon window",{ms:t,until:ge})}catch(e){}}function L(){return Date.now()<ge}function pt(t){if(!t)return null;try{let e=new URL(t,window.location.origin);if(e.protocol==="http:"||e.protocol==="https:"||e.protocol==="mailto:")return e.href}catch(e){return null}return null}var C=new Set,Ne=5e3;function O(t){let e={promise:t.catch(()=>{}),timestamp:Date.now()};return C.add(e),t.finally(()=>{C.delete(e)}),t}function ft(){return g(this,null,function*(){if(C.size===0)return;let t=new Promise(i=>{setTimeout(i,Ne)}),e=Array.from(C).map(i=>i.promise.catch(()=>{}));try{yield Promise.race([Promise.all(e),t])}catch(i){r.debug("Some requests failed during navigation wait:",i)}let n=Date.now();for(let i of Array.from(C))n-i.timestamp>Ne&&C.delete(i)})}var T=new Map,x=null,M=!1;function mt(t){try{let e=t.tagName==="A"&&t.hasAttribute("href"),n=!!t.closest("a[href]"),i=t.tagName==="BUTTON"&&t.getAttribute("type")==="submit"||t.tagName==="INPUT"&&t.getAttribute("type")==="submit",o=t.hasAttribute("data-href")||t.hasAttribute("data-url"),s=t.getAttribute("role")==="link"||t.hasAttribute("data-navigate"),a=t.closest("[onclick]"),u=!1;if(a){let c=(a.getAttribute("onclick")||"").toLowerCase();u=c.includes("location.href")||c.includes("window.location")||c.includes("document.location")||c.includes("location = '")||c.includes("assign(")||c.includes("replace(")||c.includes("href=")}return!!(e||n||i||o||s||u)}catch(e){return!1}}function ht(){var s,a,u,l;let t=null,e=window.location,n={assign:(s=e.assign)==null?void 0:s.bind(window.location),replace:(a=e.replace)==null?void 0:a.bind(window.location),pushState:(u=history.pushState)==null?void 0:u.bind(history),replaceState:(l=history.replaceState)==null?void 0:l.bind(history)};try{typeof window.location.assign=="function"&&Object.defineProperty(e,"assign",{value:c=>{r.debug("[nav-guard] intercept assign",{url:c}),t={kind:"assign",url:String(c)}}})}catch(c){r.error("Failed to intercept assign",c)}try{typeof window.location.replace=="function"&&Object.defineProperty(e,"replace",{value:c=>{r.debug("[nav-guard] intercept replace",{url:c}),t={kind:"replace",url:String(c)}}})}catch(c){r.error("Failed to intercept replace",c)}try{typeof window.history.pushState=="function"&&Object.defineProperty(history,"pushState",{value:(c,f,m)=>{let v=m?String(m):void 0;r.debug("[nav-guard] intercept pushState",{url:v}),t={kind:"history",method:"push",state:c,title:f,url:v}}})}catch(c){r.error("Failed to intercept pushState")}try{typeof window.history.replaceState=="function"&&Object.defineProperty(history,"replaceState",{value:(c,f,m)=>{let v=m?String(m):void 0;r.debug("[nav-guard] intercept replaceState",{url:v}),t={kind:"history",method:"replace",state:c,title:f,url:v}}})}catch(c){r.error("Failed to intercept replaceState")}function i(){try{n.assign&&(window.location.assign=n.assign)}catch(c){}try{n.replace&&(window.location.replace=n.replace)}catch(c){}try{n.pushState&&(history.pushState=n.pushState)}catch(c){}try{n.replaceState&&(history.replaceState=n.replaceState)}catch(c){}}function o(){return g(this,null,function*(){var f,m,v,P;let c=t;if(i(),!!c){r.debug("[nav-guard] replay navigation",c);try{switch(c.kind){case"assign":(f=n.assign)==null||f.call(n,c.url);break;case"replace":(m=n.replace)==null||m.call(n,c.url);break;case"history":c.method==="push"?(v=n.pushState)==null||v.call(n,c.state,c.title,c.url):(P=n.replaceState)==null||P.call(n,c.state,c.title,c.url),c.url&&(window.location.href=c.url);break}}catch(z){r.debug("[nav-guard] replay failed, forcing reload",z),window.location.reload()}}})}return{releaseAndReplay:o}}function vt(){M||(r.debug("[Click] Initializing document click listener"),x=t=>g(null,null,function*(){var a,u;r.debug("Captured by document click handler");let e=t.target;if(!e)return;let n=!1,i=[];for(let l of Array.from(T.values()))try{let c=K(l.cssPath);if(!c)continue;if(((a=e.matches)==null?void 0:a.call(e,c))||((u=e.closest)==null?void 0:u.call(e,c))){if(l.debounceMs){let m=Date.now();if(l.lastExecuted&&m-l.lastExecuted<l.debounceMs)continue;l.lastExecuted=m}n=!0,i.push(l)}}catch(c){r.error("Error checking handler match:",{cssPath:l.cssPath,error:c instanceof Error?c.message:"Unknown error"})}if(!n)return;r.debug("Document click matched handlers",{count:i==null?void 0:i.length,selectors:i==null?void 0:i.map(l=>l.cssPath),target:{tag:e==null?void 0:e.tagName,id:e==null?void 0:e.id,class:e==null?void 0:e.className}});let o=ht(),s=mt(e);if(s){try{$e(2e3)}catch(l){}r.debug("Click looks navigational; deferring navigation until tracking completes"),t.preventDefault(),t.stopPropagation()}try{let l=[];for(let c of i){r.debug("Click event triggered for selector:",c.cssPath);try{let f=c.callback();f instanceof Promise&&l.push(f)}catch(f){r.error("Error in click handler callback:",{cssPath:c.cssPath,error:f instanceof Error?f.message:"Unknown error"})}}if(l.length>0&&(yield Promise.all(l.map(c=>c.catch(f=>r.error("Handler rejected:",f))))),yield ft(),s){let c=(e instanceof HTMLAnchorElement?e.href:null)||e.getAttribute("data-href")||e.getAttribute("data-url")||"",f=pt(c);if(f)window.location.href=f;else if(c)r.error("Unsafe href detected, navigation prevented:",c);else if(e.closest("form")){let m=e.closest("form");m instanceof HTMLFormElement&&m.submit()}}yield o.releaseAndReplay()}catch(l){if(r.error("Error during navigation handling:",l),s){try{yield o.releaseAndReplay()}catch(c){}window.location.reload()}}}),r.debug("[Click] Attach Click Listener"),document.addEventListener("click",x,!0),M=!0,r.debug("[Click] Universal document click listener initialized"))}function Y(t,e,n=100){try{if(!t||typeof t!="string")return r.warn("Invalid CSS path provided to addDebouncedClickListener"),()=>{};if(typeof e!="function")return r.warn("Invalid callback provided to addDebouncedClickListener"),()=>{};vt();let i=`${t}_debounced_${Date.now()}_${Math.random()}`;return T.set(i,{cssPath:t,callback:e,debounceMs:n,id:i}),r.debug("Added debounced click handler for selector:",t),()=>{T.delete(i),r.debug("Removed debounced click handler for selector:",t),T.size===0&&M&&x&&(document.removeEventListener("click",x,!0),x=null,M=!1,r.debug("Universal document click listener removed"))}}catch(i){return r.error("Error adding debounced click listener:",{cssPath:t,error:i instanceof Error?i.message:"Unknown error"}),()=>{}}}function W(){try{T.clear(),M&&x&&(document.removeEventListener("click",x,!0),x=null,M=!1),r.debug("Removed event handlers during cleanup")}catch(t){r.error("Error during event listener cleanup:",t)}}function I(){return T.size}var U=!1;if(typeof document!="undefined")try{document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"&&(U=!0,r.debug("[http] document hidden: enabling beacon-friendly transport"))})}catch(t){}if(typeof window!="undefined")try{window.addEventListener("pagehide",()=>{U=!0,r.debug("[http] pagehide fired: enabling beacon-friendly transport")})}catch(t){}function bt(t){if(typeof t=="string")return t;try{return new URLSearchParams(t).toString()}catch(e){return String(t!=null?t:"")}}function pe(t,e){return g(this,null,function*(){if(typeof fetch!="function")return!1;r.debug("[http] fetch keepalive attempt",{url:t,init:e});try{return yield fetch(t,e),r.debug("[http] fetch keepalive sent",{method:(e==null?void 0:e.method)||"GET",url:t,keepalive:(e==null?void 0:e.keepalive)===!0,pageHidden:U}),!0}catch(n){r.error("fetch keepalive failed:",n)}return!1})}function yt(t,e=1500){return r.debug("[http] using image fallback",{url:t,timeoutMs:e}),new Promise(n=>{try{let i=wt(t),o=!1,s=()=>{o||(o=!0,n())},a=setTimeout(s,e);i.onload=()=>{clearTimeout(a),s()},i.onerror=()=>{clearTimeout(a),s()}}catch(i){n()}})}function Et(t,e,n="POST"){return r.debug("[http] using XHR fallback",{url:t,method:n}),new Promise(i=>{try{let o=new XMLHttpRequest;o.open(n,t),o.withCredentials=!0,o.onreadystatechange=function(){o.readyState===4&&(o.status!==204&&r.debug(`Request failed to ${t}.`),i())},o.onerror=()=>i(),n==="POST"?o.send(e!=null?e:""):o.send()}catch(o){i()}})}var xt=t=>g(null,null,function*(){let e=b,n=g(null,null,function*(){if(r.debug("[http] POST requested",{src:e}),(U||L())&&typeof navigator!="undefined"&&"sendBeacon"in navigator)try{let o=new Blob([JSON.stringify(t)],{type:"application/json"}),s=navigator.sendBeacon(b,o);r.debug("[http] POST via sendBeacon",{ok:s,pageHidden:!0,preferBeacon:L()});return}catch(o){r.debug("[http] POST beacon failed, continue to fetch/xhr",o)}if(yield pe(e,{method:"POST",mode:"no-cors",credentials:"include",keepalive:!0,body:JSON.stringify(t)})){r.debug("[http] POST using fetch keepalive");return}return r.debug("[http] POST falling back to XHR"),Et(b,JSON.stringify(t),"POST").catch(()=>{})});return O(n)}),wt=t=>{let e=document.createElement("img");return e.src=t,e.alt="",e.style.display="none",e},St=t=>g(null,null,function*(){let e=bt(t),n=`${b}?${e}`,i=g(null,null,function*(){if(r.debug("[http] GET requested",{src:n}),(U||L())&&typeof navigator!="undefined"&&"sendBeacon"in navigator)try{let s=new Blob([e],{type:"application/x-www-form-urlencoded"}),a=navigator.sendBeacon(b,s);r.debug("[http] GET via sendBeacon (POST form body)",{ok:a,pageHidden:!0,preferBeacon:L()});return}catch(s){r.debug("[http] GET beacon failed, continue to fetch/img",s)}if(L()&&(yield pe(b,{method:"POST",mode:"no-cors",credentials:"include",keepalive:!0,headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}))){r.debug("[http] GET request sent as POST keepalive due to critical window");return}if(yield pe(n,{method:"GET",mode:"no-cors",credentials:"include",keepalive:!0})){r.debug("[http] GET using fetch keepalive");return}return r.debug("[http] GET falling back to IMG"),yt(n,1500).catch(()=>{})});return O(i)}),Oe=(t,e)=>g(null,null,function*(){r.debug("[http] execute called",{method:e});let n;switch(e){case"POST":n=xt(t);break;case"GET":n=St(t);break;default:return}return n.catch(()=>{})});var Ue="10.4";var me="ndp_settings",he="ndp_settings_expiry",He=300*1e3,fe=new Map;function _t(t,e){try{let n=ze();n[t]=e,sessionStorage.setItem(me,JSON.stringify(n)),sessionStorage.setItem(he,(Date.now()+He).toString());let i=Object.keys(n).filter(o=>!o.startsWith("_"));r.debug("Cached settings for pixel:",t,{cacheSize:i.length,expiryTime:new Date(Date.now()+He).toISOString()})}catch(n){r.warn("Failed to cache settings:",n)}}function At(t){try{let e=sessionStorage.getItem(he);if(!e||Date.now()>parseInt(e))return Lt(),null;let i=ze()[t];return i&&typeof i=="object"&&!Array.isArray(i)?i:null}catch(e){return null}}function ze(){try{let t=sessionStorage.getItem(me);if(!t)return{};let e=JSON.parse(t),n={};for(let i in e)e[i]&&typeof e[i]=="object"&&!Array.isArray(e[i])&&(n[i]=e[i]);return n}catch(t){return r.warn("Failed to parse cached settings:",t),{}}}function Lt(){try{sessionStorage.removeItem(me),sessionStorage.removeItem(he),r.debug("Cleared settings cache")}catch(t){r.warn("Failed to clear settings cache:",t)}}function J(t,e=3,n=1e3,i="https://ads.nextdoor.com/v2/api/conversions/settings"){return g(this,null,function*(){let o=At(t);if(o)return r.debug("Using cached settings for pixel:",t),o;let s=fe.get(t);if(s)return r.debug("Joining existing settings request for pixel:",t),s;let a=g(null,null,function*(){try{r.debug("Starting new settings request for pixel:",t);let u=yield Ct(t,e,n,i);return _t(t,u),r.debug("Successfully fetched and cached settings for pixel:",t),u}catch(u){throw r.error("Failed to fetch settings for pixel:",t,u),u}finally{fe.delete(t)}});return fe.set(t,a),a})}function Ct(t,e=3,n=1e3,i="https://ads.nextdoor.com/v2/api/conversions/settings"){return g(this,null,function*(){let o=(s=0)=>g(null,null,function*(){try{r.debug("Fetching settings from server for pixel:",t);let a=typeof AbortSignal.timeout=="function"?AbortSignal.timeout(5e3):void 0,u=yield fetch(`${i}?id=${t}`,y({method:"GET",headers:{"Content-Type":"application/json"}},a&&{signal:a}));if(!u.ok)throw new Error(`Settings API returned ${u.status}: ${u.statusText}`);return yield u.json()}catch(a){return s<e?(r.debug(`Settings fetch failed, retrying... (${s+1}/${e})`),yield new Promise(u=>setTimeout(u,n)),o(s+1)):(r.warn("Unable to obtain settings from API. Falling back to default configuration."),{am:"0",em:{},t:Date.now()})}});return o()})}var Ve={c:"country",e:"email",g:"gender",i:"external_id",n:["first_name","last_name"],p:"phone_number",r:["city","state","zip_code"],s:"street_address"},Ge={email:["email","e-mail","mail"],phone_number:["phone","tel","telephone","mobile","cell"],first_name:["first","fname","firstname","given"],last_name:["last","lname","lastname","family","surname"],street_address:["address","street","addr"],city:["city","town","locality"],state:["state","province","region"],zip_code:["zip","postal","postcode"],country:["country","nation"],gender:["gender","sex"],external_id:["id","userid","customer_id","user_id","member_id","account_id","external_id","reference","tracking_id"]};function Tt(t){return t in Ge}function Z(t,e){if(!t)return null;let n=t.toLowerCase(),i=y(y({},Ge),e);for(let[o,s]of Object.entries(i))if(s&&s.some(a=>n.includes(a))){if(o==="street_address"&&n.includes("email"))continue;if(Tt(o))return o}return null}function ve(t,e){if(!e)return!1;if(e==="1")return!0;if(e==="0")return!1;for(let[n,i]of Object.entries(Ve))if(Array.isArray(i)){if(i.includes(t)&&e.includes(n))return!0}else if(i===t&&e.includes(n))return!0;return!1}var Mt={ssn:[/^\d{3}-\d{2}-\d{4}$/,/^\d{3}\s\d{2}\s\d{4}$/,/^\d{9}$/],creditCard:[/^4[0-9]{12}(?:[0-9]{3})?$/,/^5[1-5][0-9]{14}$/,/^3[47][0-9]{13}$/,/^3[0-9]{13}$/,/^6(?:011|5[0-9]{2})[0-9]{12}$/,/^\d{4}\s\d{4}\s\d{4}\s\d{4}$/,/^\d{4}-\d{4}-\d{4}-\d{4}$/],driversLicense:[/^[A-Z]\d{7,8}$/,/^[A-Z]{2}\d{6,7}$/,/^\d{8,9}$/,/^[A-Z]\d{3}-\d{3}-\d{3}$/],medicalId:[/^MRN\d{6,10}$/i,/^PAT\d{6,10}$/i,/^PID\d{6,10}$/i],bankAccount:[/^\d{12,17}$/,/^\d{4}\s\d{4}\s\d{4}$/],passport:[/^[A-Z]{2}\d{7}$/],taxId:[/^\d{2}-\d{7}$/,/^\d{3}-\d{2}-\d{4}$/],insurance:[/^[A-Z]{2,3}\d{8,12}$/,/^POL\d{6,10}$/i,/^INS\d{6,10}$/i],sensitiveNumeric:[/^\d{16}$/,/^\d{15}$/,/^\d{9}$/]},It=[/ssn/i,/social.?security/i,/tax.?id/i,/credit.?card/i,/card.?number/i,/ccn/i,/cvv/i,/cvc/i,/expiry/i,/expiration/i,/security.?code/i,/card.?code/i,/account.?number/i,/routing.?number/i,/bank.?account/i,/iban/i,/swift/i,/drivers?.?license/i,/dl.?number/i,/license.?number/i,/medical.?record/i,/patient.?id/i,/mrn/i,/health.?id/i,/insurance.?id/i,/passport/i,/passport.?number/i,/confidential/i,/secret/i,/private.?key/i,/password/i,/pin/i],Pt=[/payment/i,/billing/i,/checkout/i,/credit/i,/bank/i,/medical/i,/health/i,/insurance/i,/tax/i,/government/i,/identity/i,/verification/i,/kyc/i,/background.?check/i];function kt(t){return t?It.some(e=>e.test(t)):!1}function Rt(t){if(!t||typeof t!="string")return!1;let e=t.replace(/[\s-.]/g,"");for(let[n,i]of Object.entries(Mt))for(let o of i)if(o.test(e)||o.test(t))return r.warn(`Detected sensitive data pattern: ${n}`),!0;return!1}function be(){var e;let t=[document.title,document.URL,((e=document.querySelector('meta[name="description"]'))==null?void 0:e.getAttribute("content"))||""].join(" ").toLowerCase();return Pt.some(n=>n.test(t))}function Q(t,e){return kt(t)?(r.warn(`Blocked sensitive field: ${t}`),!0):Rt(e)?(r.warn(`Blocked sensitive value in field: ${t}`),!0):be()&&/^\d+$/.test(e.replace(/[\s-]/g,""))&&e.length>=8?(r.warn(`Blocked numeric data in sensitive context: ${t}`),!0):!1}var ye={email:['input[type="email"]','input[name="email"]','input[id="email"]','input[name="user_email"]','input[name="customer_email"]','input[name="billing_email"]','input[name="contact_email"]','input[id="test_email"]','input[id*="contact-email"]','input[data-tid*="email"]','input[data-testid*="email"]','input[data-tag_item="email"]','input[formcontrolname*="email"]','input[aria-label*="email" i]','input[placeholder*="email" i]','input[name*="signInName"]'].join(", "),phone_number:['input[type="tel"]','input[name="phone"]','input[id="phone"]','input[name="phone_number"]','input[name="telephone"]','input[name="mobile"]','input[name="billing_phone"]','input[id="test_phone"]','input[id*="contact-phone"]','input[data-tid*="phone"]','input[data-testid*="phone"]','input[data-tag_item="phone_number"]','input[autocomplete="tel-national"]','input[name*="signInName"]'].join(", "),first_name:['input[name="first_name"]','input[id="first_name"]','input[name="fname"]','input[name="firstname"]','input[name="billing_first_name"]','input[id="test_first_name"]','input[name="fullName"]','input[data-testid*="name"]','input[autocomplete="name"]','input[data-tag_item="name"]'].join(", "),last_name:['input[name="last_name"]','input[id="last_name"]','input[name="lname"]','input[name="lastname"]','input[name="billing_last_name"]','input[id="test_last_name"]'].join(", "),street_address:['input[name="address"]','input[name="street_address"]','input[name="address_line_1"]','input[name="billing_address"]','input[name="shipping_address"]','input[id="test_street_address"]','input[formcontrolname="streetCtrl"]','input[placeholder*="street" i]','input[placeholder*="address" i]'].join(", "),city:['input[name="city"]','input[id="city"]','input[name="billing_city"]','input[name="shipping_city"]','input[id="test_city"]'].join(", "),state:['input[name="state"]','input[id="state"]','select[name="state"]','input[name="province"]','input[name="billing_state"]','input[name="shipping_state"]','input[id="test_state"]','select[data-testid*="state"]','select[formcontrolname*="state"]'].join(", "),zip_code:['input[name="zip"]','input[name="zip_code"]','input[name="postal_code"]','input[name="postcode"]','input[name="billing_zip"]','input[name="shipping_zip"]','input[id="test_zip_code"]','input[formcontrolname="zipCodeCtrl"]','input[data-testid*="zip"]','input[placeholder*="zip" i]','input[class*="zip-code"]'].join(", "),country:['select[name="country"]','input[name="country"]','select[name="billing_country"]','select[name="shipping_country"]','select[id="test_country"]'].join(", "),gender:['select[name="gender"]','input[name="gender"]','input[type="radio"][name="gender"]','select[id="test_gender"]'].join(", "),external_id:['input[name="user_id"]','input[name="customer_id"]','input[name="member_id"]','input[name="account_id"]','input[name="external_id"]','input[id="user_id"]','input[id="customer_id"]','input[id="member_id"]','input[name="reference_id"]','input[name="tracking_id"]','input[data-testid*="user-id"]','input[data-testid*="customer-id"]','input[placeholder*="id" i]','input[placeholder*="reference" i]'].join(", ")},Ee=['button[id="checkout"]','button[class*="checkout-btn"]','button[class*="checkout-button"]','input[type="submit"][value*="checkout"]','input[type="submit"][value*="order"]','button[id="purchase"]','button[class*="purchase-btn"]','button[class*="buy-now"]','input[type="submit"][value*="purchase"]'],je={email:"email",e:"email",phone:"phone_number",p:"phone_number",fname:"first_name",lname:"last_name",first_name:"first_name",last_name:"last_name",user_id:"external_id",customer_id:"external_id",member_id:"external_id",account_id:"external_id",external_id:"external_id",uid:"external_id",ref:"external_id"};function xe(t,e){new URLSearchParams(window.location.search).forEach((i,o)=>{let s=je[o.toLowerCase()];s&&t(s)&&e(s,i)})}function we(t,e,n){new FormData(t).forEach((o,s)=>{let a=Z(s);a&&e(a)&&n(a,o.toString())})}function Se(t,e){document.querySelectorAll("form").forEach(i=>{i.querySelectorAll("input, select").forEach(s=>{let a=s;if(a.value){let u=Z(a.name||a.id);if(u&&t(u)){if(Q(u,a.value))return;e(u,a.value)}}})})}function qe(t){var i,o,s,a,u,l,c,f,m,v,P,z;let e={name:((i=t.name)==null?void 0:i.toLowerCase())||"",id:((o=t.id)==null?void 0:o.toLowerCase())||"",type:((s=t.type)==null?void 0:s.toLowerCase())||"",placeholder:((a=t.placeholder)==null?void 0:a.toLowerCase())||"",ariaLabel:((u=t.getAttribute("aria-label"))==null?void 0:u.toLowerCase())||"",dataTestId:((l=t.getAttribute("data-testid"))==null?void 0:l.toLowerCase())||"",dataTid:((c=t.getAttribute("data-tid"))==null?void 0:c.toLowerCase())||"",dataTagItem:((f=t.getAttribute("data-tag_item"))==null?void 0:f.toLowerCase())||"",formControlName:((m=t.getAttribute("formcontrolname"))==null?void 0:m.toLowerCase())||"",autocomplete:((v=t.autocomplete)==null?void 0:v.toLowerCase())||"",className:((P=t.className)==null?void 0:P.toLowerCase())||"",value:((z=t.value)==null?void 0:z.toLowerCase())||""},n=Object.values(e).join(" ");return e.type==="email"||e.dataTagItem==="email"||/email/.test(n)||e.value&&S(e.value)?"email":e.type==="tel"||e.dataTagItem==="phone_number"||/phone|tel/.test(n)||e.value&&_(e.value)?"phone_number":e.dataTagItem==="name"||/fullname|name/.test(n)?"first_name":/zip|postal|postcode/.test(n)?"zip_code":/address|street/.test(n)?"street_address":t.tagName==="SELECT"&&/state/.test(n)?"state":/user.?id|customer.?id|member.?id|account.?id|external.?id|reference.?id|tracking.?id/.test(n)?"external_id":null}function Be(t){let e=t.options[t.selectedIndex];if(!(e!=null&&e.value)||e.disabled)return"";let n=Array.from(t.options).findIndex(a=>a.value&&!a.disabled)===t.selectedIndex,i=Array.from(t.options).slice(0,t.selectedIndex).some(a=>!a.value||a.disabled),o=t.hasAttribute("data-gtm-form-interact-field-id")||t.hasAttribute("data-analytics")||t.hasAttribute("data-track")||t.hasAttribute("data-ga")||t.hasAttribute("data-fb-track")||/track|analytics|gtm|ga-/.test(t.className)||/track|analytics|gtm|ga-/.test(t.id),s=/state/.test(t.name+t.id)&&(e.value==="AL"||e.value==="AB")||/country/.test(t.name+t.id)&&(e.value==="AF"||e.value==="US")||e.value&&e.value.length<=3&&e.textContent&&e.textContent.length>e.value.length*2;return n&&i&&(o||s)?"":e.value}function Ke(t){let e=t.trim();if(!e)return{};let n=e.split(/\s+/).filter(i=>i.length>0);return n.length===1?{first_name:n[0]}:n.length===2?{first_name:n[0],last_name:n[1]}:{first_name:n[0],last_name:n.slice(1).join(" ")}}function Ye(t,e,n){let i=qe(t);if(!i||!e(i))return;let o="";if(t.tagName==="SELECT"?o=Be(t):o=t.value||"",!!o.trim())if(i==="first_name"&&o.includes(" ")){let s=Ke(o);s.first_name&&n("first_name",s.first_name),s.last_name&&e("last_name")&&n("last_name",s.last_name)}else n(i,o.trim())}function X(t,e){document.querySelectorAll("input, select, textarea").forEach(i=>{let o=i;o.type!=="password"&&o.value&&Ye(o,t,e)})}var _e=class{constructor(e){p(this,"instances",new Map);p(this,"componentName");this.componentName=e,typeof window!="undefined"&&window.addEventListener("beforeunload",()=>{this.cleanup()})}getInstance(e,n){return g(this,null,function*(){if(!e)return r.warn(`No key provided for ${this.componentName} initialization`),null;let i=this.instances.get(e);if(i&&this.isInstanceValid(i))return r.debug(`Using existing ${this.componentName} instance for key:`,e),i;try{r.debug(`Starting ${this.componentName} initialization for key:`,e);let o=yield n();return this.isInstanceValid(o)?(this.instances.set(e,o),r.debug(`Successfully initialized ${this.componentName} for key:`,e),o):(r.warn(`${this.componentName} instance created but not valid for key:`,e),null)}catch(o){return r.error(`${this.componentName} initialization failed for key:`,e,o),null}})}getExistingInstance(e){let n=this.instances.get(e);return n&&this.isInstanceValid(n)?n:null}isInstanceValid(e){return typeof e.isEnabled=="function"?e.isEnabled():typeof e.isReady=="function"?e.isReady():!0}removeInstance(e){let n=this.instances.get(e);if(n){if(typeof n.cleanup=="function")try{n.cleanup()}catch(i){r.debug(`Failed to cleanup ${this.componentName} instance:`,i)}this.instances.delete(e),r.debug(`Removed ${this.componentName} instance for key:`,e)}}getInstanceCount(){return this.instances.size}getInstanceKeys(){return Array.from(this.instances.keys())}cleanup(){r.debug(`Cleaning up ${this.componentName} instances:`,this.instances.size),this.instances.forEach((e,n)=>{if(typeof e.cleanup=="function")try{e.cleanup()}catch(i){r.debug(`Failed to cleanup ${this.componentName} instance ${n}:`,i)}}),this.instances.clear(),r.debug(`${this.componentName} cleanup completed`)}};function ee(t){return new _e(t)}var We=ee("AdvancedMatching"),ne=class ne{constructor(e){p(this,"config",null);p(this,"dataSourceId");p(this,"collectedData",{});p(this,"processingEnabled",!1);this.dataSourceId=e}enableAutoCollection(){if(!this.processingEnabled)return;let e=()=>{X(n=>this.isFieldEnabled(n),(n,i)=>this.collectField(n,i)),this.attachFormListeners(),this.collectFromUrlParams(),this.attachCheckoutListeners(),this.setupPeriodicScanning()};if(document.readyState==="loading"){let n=()=>e();document.addEventListener("DOMContentLoaded",n)}else e()}attachFormListeners(){Object.entries(ye).forEach(([e,n])=>{document.querySelectorAll(n).forEach(o=>{let s=a=>{let u=a.target;u.value&&this.isFieldEnabled(e)&&this.collectField(e,u.value)};o.addEventListener("blur",s)})})}attachCheckoutListeners(){let e=n=>{let i=n.target;this.collectFromForm(i)};document.addEventListener("submit",e),Ee.forEach(n=>{document.querySelectorAll(n).forEach(o=>{let s=()=>{setTimeout(()=>{this.collectFromCurrentPage()},ne.CHECKOUT_BUTTON_DELAY)};o.addEventListener("click",s)})})}collectFromUrlParams(){xe(e=>this.isFieldEnabled(e),(e,n)=>this.collectField(e,n))}collectFromForm(e){we(e,n=>this.isFieldEnabled(n),(n,i)=>this.collectField(n,i))}collectFromCurrentPage(){Se(e=>this.isFieldEnabled(e),(e,n)=>this.collectField(e,n))}isFieldEnabled(e){var n;return ve(e,(n=this.config)==null?void 0:n.am)}collectField(e,n){if(!(!n||!this.isFieldEnabled(e))){if(Q(e,n)){r.warn(`Blocked sensitive data collection for field: ${e}`);return}if(e==="email"&&!S(n)){r.debug("Invalid email format rejected");return}if(e==="phone_number"&&!_(n)){r.debug("Invalid phone format rejected");return}if(!(e==="email"&&!S(n))&&!(e==="phone_number"&&!_(n))&&!(e==="zip_code"&&n.length>20)&&!(e==="external_id"&&!/^[a-zA-Z0-9_-]+$/.test(n))){if(e==="external_id"){if(n.length>100||n.length<2){r.debug(`External ID invalid length: ${n.length} characters`);return}if(!/^[a-zA-Z0-9_-]+$/.test(n)){r.debug("External ID contains invalid characters");return}}if(be()&&this.isHighRiskField(e,n)){r.warn(`Blocked data collection in sensitive context for field: ${e}`);return}this.collectedData[e]=n}}}isHighRiskField(e,n){return!!(e==="external_id"&&/^\d{6,}$/.test(n)||/^\d{8,}$/.test(n.replace(/[\s-]/g,"")))}getProcessedData(){return g(this,null,function*(){this.collectFromCurrentPage();let e={};for(let[n,i]of Object.entries(this.collectedData))i&&(B.includes(n)?V(i)?e[n]=i:e[n]=yield this.safeDigestMessage(i):e[n]=i);return e})}safeDigestMessage(e){return g(this,null,function*(){try{return yield R(e)}catch(n){return e}})}getConfig(){return this.config}setupPeriodicScanning(){let e=0,n=10,i=setInterval(()=>{if(e++,e>=n){clearInterval(i);return}X(o=>this.isFieldEnabled(o),(o,s)=>this.collectField(o,s))},2e3)}isEnabled(){return this.processingEnabled}initialize(){return g(this,null,function*(){try{r.debug("Initializing AdvancedMatching for pixel:",this.dataSourceId),this.config=yield J(this.dataSourceId);let e=this.config.am;this.processingEnabled=!!e,r.debug("AdvancedMatching initialized",{dataSourceId:this.dataSourceId,enabled:this.processingEnabled,amConfig:e})}catch(e){r.warn("Advanced Matching initialization failed:",e),this.config={am:"0",em:{},t:Date.now()},this.processingEnabled=!1}})}cleanup(){this.collectedData={},this.processingEnabled=!1,this.config=null,r.debug("AdvancedMatching cleanup completed for pixel:",this.dataSourceId)}};p(ne,"CHECKOUT_BUTTON_DELAY",100);var te=ne;function Je(t){return g(this,null,function*(){r.debug("Initializing advanced matching",{dataSourceId:t});let e=new te(t);return yield e.initialize(),e.isEnabled()&&e.enableAutoCollection(),r.debug("Advanced Matching initialized",{dataSourceId:t}),e})}function Ae(t){return g(this,null,function*(){return We.getInstance(t,()=>g(null,null,function*(){return Je(t)}))})}function Le(t){return We.getExistingInstance(t)}var d={},Ft=t=>g(null,null,function*(){let e={};t&&(yield Promise.all(Object.keys(t).map(a=>g(null,null,function*(){return g(null,null,function*(){De.includes(a)?e[a]=t[a]:B.includes(a)&&(V(t[a])?e[a]=t[a]:e[a]=yield R(t[a]))}).catch(l=>{r.warn(`Failed to process custom data field '${a}':`,l)})}))).catch(a=>{r.warn("Failed to process custom data:",a)}));let n=d.pixelIdList||[],i=null;for(let a of n){let u=Le(a);if(u!=null&&u.isEnabled()){i=u;break}}if(r.debug("Checking advanced matching...",{hasAdvancedMatching:!!i,isEnabled:i==null?void 0:i.isEnabled()}),!i||!i.isEnabled())return r.debug("Advanced matching not available or not enabled. Empty custom data is sent."),e;r.debug("Getting advanced matching data...");let o=new Promise((a,u)=>setTimeout(()=>u(new Error("Advanced matching timeout")),2e3)),s=yield Promise.race([i.getProcessedData(),o]);return r.debug("Advanced matching data received:",s),s?(Object.entries(s).forEach(([a,u])=>{!e[a]&&u&&(e[a]=u)}),e):(r.debug("Advanced matching timeout"),{})}),$t=()=>((!d.pageURL||d.pageURL!==window.location.href)&&(d.pageId=k(),d.pageURL=window.location.href),d.pageId),Nt=()=>{let t="";return D()&&localStorage&&(t=localStorage.getItem(N)),t||(A(N)?t=A(N):(t=k(),F(N,t,window.location.hostname))),t},Ot=(t,e,n,i)=>g(null,null,function*(){r.debug("[track] building payload",{pid:t,eventName:e});let o={pid:t,vrs:Ue,ev:e,pl:d.pl,v:d.v,ndclid:d.ndclid,ndclid_src:d.ndclid_src||0,rf:d.rf,sem:d.sem,tm:d.sendPixelByGTM?"GTM":Fe,iid:k(),pageid:$t(),sessionid:Nt(),eid:n.event_id,cd:yield Ft(i),tz:d.tz,sw:d.screenWidth||0,sh:d.screenHeight||0,gpuV:d.gpuVendor||"",gpuR:d.gpuRenderer||"",rdu:d.rdu,rduco:d.rduco,rdust:d.rdust};r.debug("[track] payload built",o),d.sendPixelByGTM?(r.debug("[track] GTM integration send"),d.sendPixelByGTM(`${b}?${j(o)}`)):(r.debug("[track] sending via http.execute GET",{pixelPayload:o}),yield Oe(j(o),"GET"),r.debug("[track] http.execute completed",{pixelPayload:o}))});function ie(t){let e=null;return e=G(E,window.location.search||""),e?(F(E,e,window.location.hostname),{ndclid:e,ndclid_src:1}):document.referrer&&(e=G(E,document.referrer),e)?(F(E,e,window.location.hostname),{ndclid:e,ndclid_src:1}):t.sendPixelByGTM&&t.getCookieValues&&([e]=t.getCookieValues(E),e)?{ndclid:e,ndclid_src:2}:D()&&localStorage&&(e=localStorage.getItem(E),e)?{ndclid:e,ndclid_src:2}:(e=A(E),e?{ndclid:e,ndclid_src:2}:{ndclid:"",ndclid_src:0})}var Ze=t=>{d.rf=document.referrer,d.tz=Intl.DateTimeFormat().resolvedOptions().timeZone||"",d.screenHeight=window.screen.height,d.screenWidth=window.screen.width;let e=Re();e?(d.gpuVendor=e.vendor,d.gpuRenderer=e.renderer):(d.gpuVendor="",d.gpuRenderer=""),le in t?d.sem=t[le]:de in t&&(d.em=t[de]),Object.assign(d,ie(d))};function H(t,e,n){return g(this,null,function*(){if(r.debug("[track] handleTrack called",{eventName:t,hasParams:!!e,hasCustomData:!!n,url:typeof location!="undefined"?location.href:void 0}),!t||typeof t!="string")return;d.pl=location.href,crypto.subtle&&d.em&&!d.sem&&(yield R(d.em).then(s=>{d.sem=s}).catch(s=>{r.warn("Failed to hash user email:",s)}));let i=d.pixelIdList;Array.isArray(e==null?void 0:e.pixel_ids)&&(i=e.pixel_ids,i.forEach(s=>{!d.pixelIdList.includes(s)&&d.pixelIdList.push(s)})),r.debug("[track] dispatching event to pixels",{count:i.length,pixel_ids:i});let o=i.map(s=>Ot(s,t,e||{},n||{}).catch(a=>{r.error(`Failed to send tracking event for pixel ${s}:`,a)}));yield Promise.allSettled(o)})}function Ce(t){try{if(!t||typeof t!="string")return r.debug("Invalid CSS path provided to findElementBySelector"),null;let e=K(t);if(!e)return r.debug("CSS path expansion resulted in empty path:",t),null;let n=document.querySelector(e);return n||(r.debug("No element found for selector:",e),null)}catch(e){return r.warn("Error finding element by selector:",{cssPath:t,error:e instanceof Error?e.message:"Unknown error"}),null}}function Te(t){var e,n;try{if(!t)return{success:!1,value:null,error:"No element provided"};let i=null;if(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement||t instanceof HTMLSelectElement?i=t.value||null:t.hasAttribute("value")?i=t.getAttribute("value"):i=((e=t.textContent)==null?void 0:e.trim())||null,!i&&t instanceof HTMLElement){let o=(n=t.innerText)==null?void 0:n.trim();if(o&&(i=o),!i){let s=t.getAttribute("data-value")||t.getAttribute("data-price")||t.getAttribute("data-content");s&&(i=s)}}return i?{success:!0,value:i}:{success:!1,value:null,error:"No extractable value found in element"}}catch(i){return{success:!1,value:null,error:`Element value extraction failed: ${i instanceof Error?i.message:"Unknown error"}`}}}function Me(t){try{if(!t||typeof t!="string")return{success:!1,value:null,error:"Invalid extraction path provided"};let e=new URL(window.location.href);if(t.startsWith("path[")){let n=t.match(/^path\[(\d+)\]$/);if(!n)return{success:!1,value:null,error:"Invalid path extraction format"};let i=parseInt(n[1],10),s=e.pathname.split("/").filter(a=>a)[i]||null;return{success:!!s,value:s,error:s?void 0:`No path segment at index ${i}`}}if(t.startsWith("query.")){let n=t.substring(6),i=e.searchParams.get(n);return{success:!!i,value:i,error:i?void 0:`Query parameter '${n}' not found`}}if(t==="fragment"){let n=e.hash.substring(1)||null;return{success:!!n,value:n,error:n?void 0:"No fragment found"}}if(t.startsWith("fragment.")){let n=t.substring(9),o=new URLSearchParams(e.hash.substring(1)).get(n);return{success:!!o,value:o,error:o?void 0:`Fragment parameter '${n}' not found`}}return{success:!1,value:null,error:`Unsupported extraction pattern: ${t}`}}catch(e){return{success:!1,value:null,error:`URL extraction failed: ${e instanceof Error?e.message:"Unknown error"}`}}}function Qe(t){return g(this,null,function*(){let e={};if(!t||!Array.isArray(t))return r.debug("No attributes provided for processing"),e;for(let n of t)try{yield Ut(n,e)}catch(i){r.warn(`Failed to process attribute ${n.t}:`,i)}return r.debug("Processed event attributes:",e),e})}function Ut(t,e){return g(this,null,function*(){if(!t.t){r.debug("Attribute missing type field, skipping");return}let n=null,i="";if(t.s){let o=Ce(t.s);if(o){let s=Te(o);n=s.success?s.value:null}i="CSS selector"}else if(t.u){let o=Me(t.u);n=o.success?o.value:null,i="URL extraction"}else t.v!==void 0&&(n=t.v,i="static value");n?(e[t.t]=n,r.debug(`Extracted ${t.t} from ${i}:`,n)):r.debug(`No value found for attribute ${t.t} using ${i}`)})}function Xe(t){return t.e&&typeof t.e=="string"&&t.e.trim()?t.e.trim():"page_view"}function et(o){return g(this,arguments,function*(t,e={},n={},i){try{if(!t||typeof t!="string"){r.warn("Invalid event name provided to firePixelEvent");return}r.debug("Firing pixel event:",{eventName:t,nickname:i,eventParams:e,attributes:n}),yield H(t.toUpperCase(),e,Ht(n)),r.debug(`Fired pixel event: ${t}`,{eventName:t,nickname:i,eventParams:e,attributes:n})}catch(s){throw r.error(`Failed to fire pixel event ${t}:`,{error:s instanceof Error?s.message:"Unknown error",eventParams:e,attributes:n}),s}})}function Ht(t={}){let e={};if(t.content_id&&(e.order_id=t.content_id),t.price)if(t.price.startsWith("$")){let n=t.price.slice(1).trim();n!==""&&isFinite(Number(n))?e.order_value=`USD${n}`:e.order_value=t.price}else e.order_value=t.price;return e}function re(t,e,n){return g(this,null,function*(){try{let i=Xe(e),o=e.a?yield Qe(e.a):{},s={pixel_ids:[t]};n&&(s.event_id=n),e.n&&(s.event_nickname=e.n),yield et(i,s,o,e.n)}catch(i){throw r.error("Failed to process and fire event:",{rule:e,customEventId:n,error:i instanceof Error?i.message:"Unknown error"}),i}})}function w(t){try{if(!t||typeof t!="object")return!1;let e=!!(t.e&&typeof t.e=="string"),n=!!(t.s&&typeof t.s=="string"),i=!!(t.k&&typeof t.k=="string"),o=!!(t.a&&Array.isArray(t.a)&&t.a.length>0);return e||n||i||o}catch(e){return r.debug("Error validating event rule:",e),!1}}function oe(t,e,n){return g(this,null,function*(){if(!e||!Array.isArray(e)){r.debug("No rules provided for batch processing");return}let i=e.filter(w);if(i.length===0){r.debug("No valid rules found for batch processing");return}r.debug(`Processing ${i.length} valid rules out of ${e.length} total`);let o=i.map(s=>re(t,s,n).catch(a=>{r.error("Failed to process rule in batch:",{rule:s,error:a})}));yield Promise.all(o)})}var zt=ee("EventsMapping"),ae=class ae{constructor(e,n={}){p(this,"dataSourceId");p(this,"settings",null);p(this,"currentPath","");p(this,"currentDomain","");p(this,"currentUrl","");p(this,"listeners",new Map);p(this,"isInitialized",!1);p(this,"config");this.dataSourceId=e,this.config=y(y({},ae.DEFAULT_CONFIG),n),this.updateCurrentPageInfo(),this.setupPageUnloadCleanup(),r.debug("EventsMapping initialized",{path:this.currentPath,config:this.config})}updateCurrentPageInfo(){typeof window!="undefined"&&(this.currentUrl=window.location.href,this.currentDomain=`${window.location.protocol}//${window.location.host}`,this.currentPath=window.location.pathname)}getRuleCount(){var e;return(e=this.settings)!=null&&e.em?Object.values(this.settings.em).reduce((n,i)=>n+(Array.isArray(i)?i.length:0),0):0}applyEventMappings(){return g(this,null,function*(){if(!this.isReady()){r.warn("EventsMapping not initialized, cannot apply mappings",{dataSourceId:this.dataSourceId});return}try{this.updateCurrentPageInfo(),r.debug("Applying event mappings",{path:this.currentPath,url:this.currentUrl}),yield this.processPageViewEvents(),yield this.processKeywordEvents(),yield this.processClickEvents(),r.debug("Event mappings applied successfully",{activeListeners:I(),registeredListeners:this.listeners.size})}catch(e){throw r.error("Failed to apply event mappings:",e),e}})}processPageViewEvents(){return g(this,null,function*(){try{let e=this.getPageViewRules();if(e.length===0){r.debug("No page view rules found for current page");return}r.debug(`Processing ${e.length} page view rules`),yield oe(this.dataSourceId,e)}catch(e){r.error("Failed to process page view events:",e)}})}getPageViewRules(){var u;let e=[];if(!((u=this.settings)!=null&&u.em))return e;let n=this.settings.em[this.currentDomain];if(!n)return e;let o=(n[this.currentPath]||[]).filter(l=>w(l)&&!l.s&&!l.k);e.push(...o);let a=(n.all||[]).filter(l=>w(l)&&!l.s&&!l.k);return e.push(...a),e}processKeywordEvents(){return g(this,null,function*(){try{let e=this.getKeywordMatchingRules();if(e.length===0){r.debug("No keyword rules match current URL");return}r.debug(`Processing ${e.length} keyword rules`),yield oe(this.dataSourceId,e)}catch(e){r.error("Failed to process keyword events:",e)}})}getKeywordMatchingRules(){var o;let e=[];if(!((o=this.settings)!=null&&o.em))return e;let n=this.settings.em[this.currentDomain];if(!n)return e;let i=n.all||[];for(let s of i)w(s)&&s.k&&this.urlContainsKeyword(s.k)&&e.push(s);return e}urlContainsKeyword(e){try{if(!e||typeof e!="string")return!1;let n=this.currentUrl.toLowerCase(),i=e.toLowerCase();return n.includes(i)}catch(n){return r.debug("Error checking keyword match:",n),!1}}processClickEvents(){return g(this,null,function*(){try{let e=this.getClickRules();if(e.length===0){r.debug("No click rules found for current page");return}r.debug(`processClickEvents: setting up ${e.length} click event listeners`,{path:this.currentPath}),this.setupClickListeners(e)}catch(e){r.error("Failed to process click events:",e)}})}getClickRules(){var u;let e=[];if(!((u=this.settings)!=null&&u.em))return e;let n=this.settings.em[this.currentDomain];if(!n)return e;let o=(n[this.currentPath]||[]).filter(l=>w(l)&&l.s);e.push(...o);let a=(n.all||[]).filter(l=>w(l)&&l.s&&!l.k);return e.push(...a),e}setupClickListeners(e){for(let n of e)if(n.s)try{r.debug("setupClickListeners: registering listener",{selector:n.s,debounce:this.config.debounceDelay,event:n.e,nickname:n.n}),this.setupSingleClickListener(n)}catch(i){r.error("Failed to setup click listener for rule:",{rule:n,error:i})}}setupSingleClickListener(e){if(!e.s)return;let n=`${e.s}_${Date.now()}_${Math.random()}`,i=()=>g(this,null,function*(){try{r.debug("Click event triggered",{selector:e.s,rule:e}),yield re(this.dataSourceId,e)}catch(a){r.error("Failed to process click event:",a)}}),o=Y(e.s,i,this.config.debounceDelay),s={selector:e.s,eventName:e.e||"page_view",nickname:e.n,attributes:e.a||[],cleanup:o};this.listeners.set(n,s),r.debug("Click listener registered",{selector:e.s,eventName:s.eventName,totalListeners:this.listeners.size})}setupPageUnloadCleanup(){typeof window!="undefined"&&window.addEventListener("beforeunload",()=>{this.cleanup()})}initialize(){return g(this,null,function*(){r.debug("Initializing EventsMapping for pixel:",this.dataSourceId);try{this.settings=yield J(this.dataSourceId)}catch(e){this.settings={am:"0",em:{},t:Date.now()},r.warn("EventsMapping cannot fetch a remote setting. Using default setting",this.settings)}r.debug("EventsMapping initialized",{dataSourceId:this.dataSourceId,initialized:this.isInitialized}),this.isInitialized=!0,this.refresh()})}cleanup(){try{r.debug("Cleaning up EventsMapping",{listenersToRemove:this.listeners.size,activeListeners:I()});for(let[e,n]of Array.from(this.listeners.entries()))try{n.cleanup()}catch(i){r.debug(`Failed to cleanup listener ${e}:`,i)}this.listeners.clear(),W(),this.isInitialized=!1,this.settings=null,r.debug("EventsMapping cleanup completed")}catch(e){r.error("Error during EventsMapping cleanup:",e)}}getRuleContext(){return{currentPath:this.currentPath,currentUrl:this.currentUrl}}getStatus(){var e;return{isInitialized:this.isInitialized,hasSettings:!!this.settings,settingsTimestamp:(e=this.settings)==null?void 0:e.t,ruleCount:this.getRuleCount(),listenerCount:this.listeners.size,activeListenerCount:I(),currentPath:this.currentPath}}isReady(){return r.debug("Check if EventsMapping is ready",{dataSourceId:this.dataSourceId,isInitialized:this.isInitialized,settings:this.settings}),this.isInitialized&&!!this.settings}refresh(){return g(this,null,function*(){if(!this.isReady()){r.warn("EventsMapping not ready, cannot refresh");return}r.debug("Refreshing EventsMapping for current page");for(let e of Array.from(this.listeners.values()))e.cleanup();this.listeners.clear(),yield this.applyEventMappings()})}};p(ae,"DEFAULT_CONFIG",{debug:!1,debounceDelay:100});var se=ae;function tt(t,e){return g(this,null,function*(){r.debug("Initializing events mapping",{dataSourceId:t});let n=new se(t,e);return yield n.initialize(),r.debug("Events mapping initialized",{dataSourceId:t}),n})}function Ie(t,e){return g(this,null,function*(){return zt.getInstance(t,()=>g(null,null,function*(){return tt(t,e)}))})}var nt="ndp_opener_host";var Vt=["localhost","ads.nextdoor-test.com","ads.nextdoor.com","ads-tools.nextdoor.com"],it="ndp_access_token",Gt="ndp_adbr_advt",jt="ndp_cds_id",qt=()=>sessionStorage.getItem(it),rt=()=>{let t="https://ads.nextdoor.com/v2/public/pixel/events-setup.js";if(document.querySelector(`script[src="${t}"]`)){r.debug("events-setup.js has been loaded. Skipping loading");return}let n=document.createElement("script");n.src=t,n.async=!0,document.body.appendChild(n),r.debug("events-setup.js is loaded successfully!")},Bt=()=>{let t=e=>{try{if(!e.origin||!e.data)return;let n="";try{n=new URL(e.origin).hostname}catch(i){return}Vt.includes(n)&&e.data.action==="share-access-token"&&(sessionStorage.setItem(it,e.data.accessToken),sessionStorage.setItem(Gt,e.data.advtId),sessionStorage.setItem(jt,e.data.cdsId),sessionStorage.setItem(nt,e.data.openerHost),rt())}catch(n){r.warn("Error processing message:",n)}};window.addEventListener("message",t,{once:!0})},ot=t=>{if(t||r.error("Unable to initialize event setup. Data Source ID is missing."),document.getElementById("event-setup-root")){r.info("Event Setup Tool has been created. Skipping initEventsSetup.");return}qt()?rt():Bt();try{window.opener&&typeof window.opener.postMessage=="function"&&window.opener.postMessage({action:"pixel-loaded",dataSourceIds:t},"*")}catch(i){r.debug("Unable to send pixel-loaded message:",i)}r.info("Event Setup Tool has been initialized successfully.")};var st={init:(t,e)=>{Kt(t,e)},restricteddatausage:(t,e)=>Yt(t,e),track:(t,e,n)=>H(t,e,n),ndclid:()=>ie(d)},Kt=(t,e)=>g(null,null,function*(){!d.pixelIdList.includes(t)&&d.pixelIdList.push(t),Ze(e),ot(d.pixelIdList),Ie(t),Ae(t)}),Yt=(t,e)=>{d.rdu=1,typeof t=="number"&&(d.rduco=t,typeof e=="number"&&(d.rdust=e))},Wt=(t,...e)=>{if(typeof st[t]=="function")return st[t](...e)},at=()=>{var e;let t=d.queue=Array.isArray(d.queue)?d.queue:[];for(;t.length;){let n=[...(e=t.shift())!=null?e:[]],i=n[0];typeof i=="string"&&Wt(i,...n.slice(1))}},Pe=(...t)=>{d.queue.push(t),d.processQueue()};var Jt=(t,e)=>{var n;return t.ndp&&Object.assign(d,t.ndp),d.v=d.v||((n=t.ndp)==null?void 0:n.v),d.pixelIdList=d.pixelIdList||[],d.processQueue=at,d.handleRequest=Pe,t.ndp=Pe,{processQueue:d.processQueue}},ct=Jt;try{ct(window,document).processQueue()}catch(t){console.log(t),console.log("Problem with request")}})();
